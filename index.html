<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的书架</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="app">
    <div class="bg-overlay"></div>

    <!-- 主界面 -->
    <div class="main-content" 
         @touchstart="handleTouchStart"
         @touchend="handleMainTouchEnd">
        
        <div class="header">
            <h1>小说</h1>
            <div v-if="currentFolder" class="header-breadcrumb">
                <i class="ri-folder-open-line"></i>
                <span>{{ currentFolder.name }}</span>
            </div>
        </div>

        <div v-if="currentItems.length === 0" class="empty-state">
            <i class="ri-book-mark-line"></i>
            <p>空空如也</p>
        </div>

        <div class="grid">
            <div v-for="folder in currentFoldersList" :key="'f-'+folder.id" 
                 class="card glass" :class="{selected: isSelected(folder.id, 'folder')}"
                 @click="handleCardClick(folder, 'folder')"
                 @touchstart="startLongPress(folder, 'folder')"
                 @touchend="cancelLongPress"
                 @contextmenu.prevent>
                <div class="folder-preview">
                    <div class="mini-doc"></div><div class="mini-doc"></div>
                    <div class="mini-doc"></div><div class="mini-doc"></div>
                </div>
                <div class="card-title">{{ folder.name }}</div>
                <div class="select-indicator" v-if="isSelectionMode"><i class="ri-check-line" v-if="isSelected(folder.id, 'folder')"></i></div>
            </div>

            <div v-for="novel in currentNovelsList" :key="'n-'+novel.id" 
                 class="card glass" :class="{selected: isSelected(novel.id, 'novel')}"
                 @click="handleCardClick(novel, 'novel')"
                 @touchstart="startLongPress(novel, 'novel')"
                 @touchend="cancelLongPress"
                 @contextmenu.prevent>
                 <i class="ri-book-open-line card-icon"></i>
                <div class="card-title">{{ novel.title }}</div>
                <div class="card-author">{{ novel.author }}</div>
                <div class="card-tag" v-if="novel.platform">{{ novel.platform }}</div>
                <div class="select-indicator" v-if="isSelectionMode"><i class="ri-check-line" v-if="isSelected(novel.id, 'novel')"></i></div>
            </div>
        </div>
    </div>

    <!-- 底部多选操作栏 -->
    <div class="selection-bar" :class="{show: isSelectionMode}">
        <button class="btn" style="flex:1;" @click="exitSelectionMode">取消</button>
        <button class="btn" style="flex:2; border-color: rgba(255,255,255,0.4);" @click="openMoveModal">
            移动 ({{ selectedItems.length }})
        </button>
    </div>

    <!-- FAB -->
    <div class="fab-container" :class="{open: showFabMenu && !isSelectionMode}" v-show="!isSelectionMode">
        <div class="fab-item" @click="openAddModal('manual')"><i class="ri-edit-line"></i></div>
        <div class="fab-item" @click="openAddModal('folder')"><i class="ri-folder-add-line"></i></div>
        <label class="fab-item" for="fileInput"><i class="ri-image-line"></i></label>
        <div class="fab-main" :class="{active: showFabMenu}" @click="showFabMenu = !showFabMenu">
            <i class="ri-add-line"></i>
        </div>
    </div>
    <input type="file" id="fileInput" accept="image/*" @change="handleAiUpload">

    <!-- 设置面板 -->
    <div class="settings-panel" :class="{open: showSettings}"
         @touchstart="handleTouchStart" @touchend="handleSettingsTouchEnd">
        <div class="header" style="padding:20px;"><h2>设置</h2></div>
        <div class="full-view-content">
            <input type="text" v-model="searchQuery" class="input-glass" 
                   placeholder="搜索..." @keyup.enter="performSearch">
            <button v-if="searchQuery" class="btn" style="margin-top:0; margin-bottom:20px;" @click="performSearch">搜索</button>

            <h3 class="section-title">藏书总览</h3>
            <div v-if="Object.keys(novelsByPlatform).length === 0" style="opacity:0.5; font-size:12px; margin-bottom:10px;">暂无数据</div>
            <div v-for="(list, platform) in novelsByPlatform" :key="platform" 
                 class="stat-row" @click="openFilteredView(platform, list)">
                <span>{{ platform || '其他' }}</span>
                <span style="opacity:0.7">{{ list.length }} <i class="ri-arrow-right-s-line"></i></span>
            </div>

            <h3 class="section-title">数据 & 外观</h3>
            <div style="display:flex; gap:10px;">
                <button class="btn" @click="exportData">备份</button>
                <button class="btn" @click="triggerImport">导入</button>
            </div>
            
            <div style="margin-top:15px; display:flex; gap:10px;">
                 <input type="color" v-model="bgColor" class="color-picker-input">
                 <button class="btn" style="margin-top:0; flex:1;" @click="triggerBgUpload">换背景图</button>
                 <button class="btn" style="margin-top:0; width:50px;" v-if="bgImage" @click="removeBg">
                     <i class="ri-delete-bin-line"></i>
                 </button>
            </div>
            
            <h3 class="section-title">AI 设置</h3>
            <!-- 供应商选择 -->
            <div class="input-glass select-trigger" @click="showProviderPicker = true">
                 <span>{{ apiProvider === 'zhipu' ? '智谱 AI' : 'OpenAI (及公益站)' }}</span>
                 <i class="ri-arrow-down-s-line"></i>
            </div>
            
            <!-- 分离的 Key 输入框 -->
            <div v-if="apiProvider === 'zhipu'">
                <input type="password" v-model="zhipuKey" class="input-glass" placeholder="智谱 API Key">
                <div style="font-size:12px; opacity:0.6; margin-bottom:10px;">* 自动使用 GLM-4V 模型</div>
            </div>
            
            <div v-if="apiProvider === 'openai'">
                <input type="password" v-model="openaiKey" class="input-glass" placeholder="OpenAI/公益站 API Key">
                <input v-model="apiUrl" class="input-glass" placeholder="API URL (例如 https://api.openai.com/v1)">
                
                <button class="btn" @click="fetchModels" style="margin-top:5px; margin-bottom:12px;">
                    <i class="ri-link" style="margin-right:5px;"></i> 链接 / 刷新模型
                </button>

                <div class="input-glass select-trigger" @click="openModelPicker">
                    <span v-if="apiModel">{{ apiModel }}</span>
                    <span v-else style="opacity:0.5;">点击选择模型...</span>
                    <i class="ri-arrow-down-s-line"></i>
                </div>
            </div>
            
            <button class="btn" @click="openConfirm('确定清空所有数据？此操作无法撤销。', clearData)" style="margin-top:40px; margin-bottom:50px; opacity:0.7;">清空所有数据</button>
        </div>
    </div>

    <!-- 筛选/搜索结果 -->
    <div class="full-view" :class="{show: showFilteredView}"
         @touchstart="handleTouchStart" @touchend="handleGenericSwipeBack($event, closeFilteredView)">
        <div class="header" style="padding:20px;">
            <i class="ri-arrow-left-line" style="font-size:24px;" @click="closeFilteredView"></i>
            <span>{{ filterTitle }}</span>
            <div style="width:24px;"></div>
        </div>
        <div class="full-view-content">
            <div class="grid">
                <div v-for="novel in filteredList" :key="'f-'+novel.id" 
                     class="card glass" @click="openDetail(novel)">
                     <div class="card-title">{{ novel.title }}</div>
                     <div class="card-author">{{ novel.author }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 详情页 -->
    <div class="full-view" :class="{show: showDetail}" v-if="activeNovel"
         @touchstart="handleTouchStart" @touchend="handleGenericSwipeBack($event, closeDetail)">
        <div class="header" style="padding:20px;">
            <i class="ri-arrow-left-line" style="font-size:24px;" @click="closeDetail"></i>
            <span>详情</span>
            <div style="width:24px;"></div>
        </div>
        <div class="full-view-content">
            <div class="detail-header">
                <div class="detail-title">{{ activeNovel.title }}</div>
                <!-- 作者可点击 -->
                <div class="detail-author clickable" @click="filterByAuthor(activeNovel.author)">
                    {{ activeNovel.author }} <i class="ri-arrow-right-s-line" style="font-size:12px; vertical-align:middle;"></i>
                </div>
                <div class="detail-platform">{{ activeNovel.platform }}</div>
            </div>
             <div class="info-block">
                <label>创建日期</label>
                <div style="font-size:16px;">{{ formatDate(activeNovel.createTime) }}</div>
            </div>
            
            <!-- 多重阅读日期 -->
            <div class="info-block">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <label style="margin:0;">阅读记录</label>
                    <div class="add-date-btn" @click="addReadDate"><i class="ri-add-line"></i></div>
                </div>
                <div class="date-tags">
                    <div v-for="(date, idx) in activeNovel.readDates" :key="idx" class="date-tag">
                        <input type="date" v-model="activeNovel.readDates[idx]" class="date-input-mini">
                        <i class="ri-close-line remove-date" @click="removeReadDate(idx)"></i>
                    </div>
                    <div v-if="!activeNovel.readDates || activeNovel.readDates.length === 0" style="opacity:0.5; font-size:13px;">暂无记录，点击 + 添加</div>
                </div>
            </div>

            <div class="info-block" style="min-height: 200px;">
                <label style="display:block; margin-bottom:5px;">书评</label>
                <textarea v-model="activeNovel.review" class="review-area" placeholder="记录当下的想法..."></textarea>
            </div>
        </div>
    </div>

    <!-- 统一添加/编辑弹窗 -->
    <div class="modal-mask" :class="{show: showAddModal}" @click.self="closeAddModal">
        <div class="modal-card">
            <h3 class="modal-title">
                {{ addFormMode === 'edit' ? '编辑信息' : (addFormType === 'folder' ? '新建文件夹' : '手动添加') }}
            </h3>
            <div v-if="addFormType === 'folder'">
                 <input v-model="addForm.title" class="input-glass" placeholder="文件夹名称">
            </div>
            <div v-else>
                <input v-model="addForm.title" class="input-glass" placeholder="书名">
                <input v-model="addForm.author" class="input-glass" placeholder="作者">
                <input v-model="addForm.platform" class="input-glass" placeholder="平台 (如起点)">
            </div>
            <div class="modal-actions">
                <button class="btn" @click="closeAddModal" style="opacity:0.7">取消</button>
                <button class="btn" @click="confirmAddOrEdit">确定</button>
            </div>
        </div>
    </div>

    <!-- 移动文件夹选择器弹窗 -->
    <div class="modal-mask" :class="{show: showMoveModal}" @click.self="closeMoveModal">
        <div class="modal-card" style="height: 60vh;">
            <h3 class="modal-title">移动到...</h3>
            <div class="breadcrumb">
                <span @click="moveNavTo(null)" style="padding:5px;">根目录</span>
                <span v-for="p in movePath" :key="p.id" style="display:flex; align-items:center;">
                    <i class="ri-arrow-right-s-line"></i>
                    <span @click="moveNavTo(p)" style="padding:5px; white-space:nowrap;">{{ p.name }}</span>
                </span>
            </div>
            <div class="folder-list-container">
                <div v-if="moveCurrentSubfolders.length === 0" class="empty-list-text">没有子文件夹</div>
                <div v-for="f in moveCurrentSubfolders" :key="f.id" class="folder-list-item" @click="enterMoveFolder(f)">
                    <i class="ri-folder-line"></i>
                    <span>{{ f.name }}</span>
                    <i class="ri-arrow-right-s-line" style="opacity:0.5;"></i>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn" @click="closeMoveModal" style="opacity:0.7">取消</button>
                <button class="btn" @click="confirmMove">移动至此</button>
            </div>
        </div>
    </div>

    <!-- 模型选择列表弹窗 -->
    <div class="modal-mask" :class="{show: showModelPicker}" @click.self="showModelPicker = false">
        <div class="modal-card" style="height: 60vh;">
            <h3 class="modal-title">选择模型</h3>
            <div class="folder-list-container">
                <div v-if="modelList.length === 0" class="empty-list-text">暂无模型列表，请先点击链接/刷新</div>
                <div v-for="m in modelList" :key="m.id" class="folder-list-item" @click="selectModel(m.id)">
                    <i class="ri-robot-line"></i>
                    <span style="flex:1;">{{ m.id }}</span>
                    <i v-if="apiModel === m.id" class="ri-check-line"></i>
                </div>
            </div>
             <div class="modal-actions">
                <button class="btn" @click="showModelPicker = false">取消</button>
            </div>
        </div>
    </div>
    
    <!-- 供应商选择 -->
     <div class="modal-mask" :class="{show: showProviderPicker}" @click.self="showProviderPicker = false">
        <div class="modal-card">
            <h3 class="modal-title">选择 API 供应商</h3>
            <button class="btn" @click="apiProvider='zhipu'; showProviderPicker=false">智谱 AI</button>
            <button class="btn" @click="apiProvider='openai'; showProviderPicker=false">OpenAI (及公益站)</button>
        </div>
    </div>

    <!-- 统一确认弹窗 -->
    <div class="modal-mask" :class="{show: showConfirmModal}" @click.self="closeConfirm">
        <div class="modal-card">
            <div class="confirm-text">{{ confirmMessage }}</div>
            <div class="modal-actions">
                <button class="btn" @click="closeConfirm" style="opacity:0.7">取消</button>
                <button class="btn" @click="executeConfirm">确定</button>
            </div>
        </div>
    </div>

    <!-- 操作菜单 -->
    <div class="action-mask" :class="{show: showActionSheet}" @click="closeActionSheet"></div>
    <div class="action-sheet" :class="{show: showActionSheet}">
        <div class="action-title">
            {{ selectedItem?.title || selectedItem?.name }}
        </div>
        <button class="btn" @click="enterSelectionModeFromSheet">多选 / 移动</button>
        <button v-if="selectedType === 'novel'" class="btn" @click="openEditModalFromSheet">编辑信息</button>
        <button v-if="selectedType === 'folder'" class="btn" @click="openRenameFromSheet">重命名</button>
        <button class="btn btn-danger" @click="openConfirm('确定删除？', deleteItem)">删除</button>
        <button class="btn btn-cancel" @click="closeActionSheet">取消</button>
    </div>

    <!-- 裁剪 (修复版) -->
    <div class="cropper-modal" v-if="showCropper">
        <div class="cropper-area" ref="cropArea" @touchstart="cropTouchStart" @touchmove="cropTouchMove">
            <img :src="tempBgSrc" class="crop-target-img" ref="cropImg" @load="initCropBox">
            <div class="crop-box" v-if="cropBox.w" :style="cropBoxStyle">
                <div class="crop-corner tl"></div><div class="crop-corner tr"></div>
                <div class="crop-corner bl"></div><div class="crop-corner br"></div>
            </div>
            <div class="crop-tip">
                拖动以移动 · 双指缩放
            </div>
        </div>
        <div class="crop-actions">
            <button class="btn" style="border-color:rgba(255,255,255,0.3);" @click="showCropper=false">取消</button>
            <button class="btn" @click="confirmCrop">应用壁纸</button>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast-container" :class="{show: toastVisible}">
        <div class="toast">
            <i class="ri-information-line"></i>
            <span>{{ toastMsg }}</span>
        </div>
    </div>

    <!-- 极简加载动画 -->
    <div class="loading-overlay" v-if="isLoading">
        <i class="ri-loader-4-line ri-spin simple-loader"></i>
    </div>

    <input type="file" id="bgInput" accept="image/*" @change="handleBgSelect">
    <input type="file" id="importInput" accept=".json" @change="handleImportData">
</div>

<script src="app.js"></script>
</body>
</html>
