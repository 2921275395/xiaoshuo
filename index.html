<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的书架 - ReadFlow</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 引入图标库 -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-color: #333;
            --card-radius: 24px;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            transition: background 0.5s;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* 遮罩层，让背景稍微暗一点，突显毛玻璃 */
        .bg-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.1);
            z-index: -1;
        }

        /* 主容器 */
        #app {
            position: relative;
            width: 100%;
            min-height: 100vh;
            overflow: hidden;
        }

        /* 首页内容区 */
        .main-content {
            padding: 20px;
            transition: transform 0.3s ease;
            min-height: 100vh;
        }

        .main-content.shifted {
            transform: translateX(-80%); /* 向左滑出 */
            filter: blur(2px);
        }

        /* 顶部栏 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .header h1 { margin: 0; font-size: 24px; font-weight: 700; }

        /* 卡片网格 */
        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        /* 毛玻璃卡片样式 */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: var(--card-radius);
            padding: 15px;
            aspect-ratio: 1 / 1.2;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            position: relative;
            transition: transform 0.2s;
            overflow: hidden;
        }

        .card:active { transform: scale(0.96); }

        /* 文件夹样式 */
        .folder-preview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            width: 50%;
            height: 50%;
            margin-bottom: 10px;
            opacity: 0.8;
        }
        .mini-doc {
            background: rgba(255,255,255,0.4);
            border-radius: 4px;
        }

        .card-title { font-size: 16px; font-weight: bold; margin-bottom: 4px; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .card-author { font-size: 12px; opacity: 0.8; }
        .card-tag { 
            font-size: 10px; 
            background: rgba(255,255,255,0.2); 
            padding: 2px 6px; 
            border-radius: 10px; 
            margin-top: 5px; 
        }

        /* 底部添加按钮 */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 100;
        }

        /* 设置面板 (右侧滑出) */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -100%; /* 默认隐藏 */
            width: 80%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            transition: right 0.3s ease;
            z-index: 200;
            padding: 30px;
            box-sizing: border-box;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            color: #333;
        }
        .settings-panel.open { right: 0; }

        .setting-item { margin-bottom: 25px; }
        .setting-label { display: block; font-weight: bold; margin-bottom: 10px; }
        .setting-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 10px;
            background: rgba(255,255,255,0.5);
        }

        /* 操作菜单 (长按触发) */
        .action-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            transform: translateY(100%);
            transition: transform 0.3s;
            z-index: 300;
            box-sizing: border-box;
        }
        .action-sheet.show { transform: translateY(0); }
        .action-btn {
            display: block;
            width: 100%;
            padding: 15px;
            text-align: center;
            background: #f5f5f5;
            margin-bottom: 10px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
        }
        .action-btn.danger { color: red; background: #fff0f0; }

        /* 遮罩 */
        .mask {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 150;
            display: none;
        }
        .mask.show { display: block; }

        /* Loading */
        .loading {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 500;
            display: none;
        }
        .loading.show { display: block; }

        /* 隐藏的文件输入 */
        #fileInput { display: none; }
    </style>
</head>
<body>

<div id="app">
    <!-- 背景遮罩 -->
    <div class="bg-overlay"></div>

    <!-- 加载中提示 -->
    <div class="loading" :class="{show: isLoading}">
        <i class="ri-loader-4-line ri-spin"></i> 正在识别中...
    </div>

    <!-- 首页内容 -->
    <div class="main-content" 
         :class="{shifted: showSettings}"
         @touchstart="handleTouchStart"
         @touchend="handleTouchEnd">
        
        <div class="header">
            <h1>ReadFlow</h1>
            <i class="ri-settings-4-line" @click="showSettings = true" style="font-size: 24px;"></i>
        </div>

        <div class="header" v-if="currentFolder">
            <span @click="exitFolder"><i class="ri-arrow-left-line"></i> 返回</span>
            <span>{{ currentFolder.name }}</span>
        </div>

        <div class="grid">
            <!-- 渲染文件夹 -->
            <div v-for="folder in displayFolders" :key="folder.id" 
                 class="card"
                 @click="enterFolder(folder)"
                 @touchstart="startLongPress(folder, 'folder')"
                 @touchend="cancelLongPress"
                 @contextmenu.prevent>
                <div class="folder-preview">
                    <div class="mini-doc"></div><div class="mini-doc"></div>
                    <div class="mini-doc"></div><div class="mini-doc"></div>
                </div>
                <div class="card-title">{{ folder.name }}</div>
            </div>

            <!-- 渲染小说 -->
            <div v-for="novel in displayNovels" :key="novel.id" 
                 class="card"
                 @click="viewNovel(novel)"
                 @touchstart="startLongPress(novel, 'novel')"
                 @touchend="cancelLongPress"
                 @contextmenu.prevent>
                 <i class="ri-book-open-line" style="font-size: 32px; margin-bottom: 10px;"></i>
                <div class="card-title">{{ novel.title }}</div>
                <div class="card-author">{{ novel.author }}</div>
                <div class="card-tag" v-if="novel.platform">{{ novel.platform }}</div>
            </div>
        </div>
    </div>

    <!-- 底部添加按钮 -->
    <label class="fab" for="fileInput" v-if="!showSettings">
        <i class="ri-add-line"></i>
    </label>
    <input type="file" id="fileInput" accept="image/*" @change="handleImageUpload">

    <!-- 设置面板 -->
    <div class="settings-panel" :class="{open: showSettings}">
        <div class="header" style="color: #333;">
            <h2>设置</h2>
            <i class="ri-close-line" @click="showSettings = false" style="font-size: 24px;"></i>
        </div>

        <div class="setting-item">
            <label class="setting-label">智谱 API Key</label>
            <input type="password" v-model="apiKey" class="setting-input" placeholder="输入 API Key">
            <p style="font-size: 12px; color: #888; margin-top: 5px;">key保存在本地，不会上传服务器</p>
        </div>

        <div class="setting-item">
            <label class="setting-label">背景颜色</label>
            <input type="color" v-model="bgColor" class="setting-input" style="height: 50px;">
        </div>

        <div class="setting-item">
            <label class="setting-label">自定义背景图 URL</label>
            <input type="text" v-model="bgImage" class="setting-input" placeholder="https://...">
        </div>
        
        <button class="action-btn" @click="saveSettings">保存配置</button>
        <button class="action-btn danger" @click="clearData">清空所有数据</button>
    </div>

    <!-- 操作遮罩 -->
    <div class="mask" :class="{show: showActionSheet}" @click="closeActionSheet"></div>

    <!-- 底部操作菜单 -->
    <div class="action-sheet" :class="{show: showActionSheet}">
        <div style="text-align: center; margin-bottom: 15px; color: #888; font-size: 14px;">
            对 "{{ selectedItem?.name || selectedItem?.title }}" 的操作
        </div>
        
        <button class="action-btn" @click="moveToFolderAction" v-if="selectedType === 'novel' && !currentFolder">
            移入文件夹
        </button>
        
        <button class="action-btn" @click="createFolderWithItem" v-if="selectedType === 'novel' && !currentFolder">
            新建文件夹并移入
        </button>

        <button class="action-btn" @click="renameAction">重命名</button>
        <button class="action-btn danger" @click="deleteAction">删除</button>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            // 数据状态
            const novels = ref([]);
            const folders = ref([]);
            const apiKey = ref('');
            const bgColor = ref('#8EC5FC');
            const bgImage = ref('');
            
            // UI 状态
            const showSettings = ref(false);
            const isLoading = ref(false);
            const currentFolder = ref(null);
            
            // 长按/操作逻辑
            const showActionSheet = ref(false);
            const selectedItem = ref(null);
            const selectedType = ref(''); // 'novel' or 'folder'
            let longPressTimer = null;
            let touchStartX = 0;

            // 初始化加载数据
            onMounted(() => {
                const savedNovels = localStorage.getItem('rf_novels');
                const savedFolders = localStorage.getItem('rf_folders');
                const savedConfig = localStorage.getItem('rf_config');

                if (savedNovels) novels.value = JSON.parse(savedNovels);
                if (savedFolders) folders.value = JSON.parse(savedFolders);
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    apiKey.value = config.apiKey || '';
                    bgColor.value = config.bgColor || '#8EC5FC';
                    bgImage.value = config.bgImage || '';
                }
                updateBackground();
            });

            // 监听数据变化自动保存
            watch([novels, folders], () => {
                localStorage.setItem('rf_novels', JSON.stringify(novels.value));
                localStorage.setItem('rf_folders', JSON.stringify(folders.value));
            }, { deep: true });

            // 计算属性：根据当前是否在文件夹内显示内容
            const displayNovels = computed(() => {
                if (currentFolder.value) {
                    return novels.value.filter(n => n.folderId === currentFolder.value.id);
                }
                return novels.value.filter(n => !n.folderId);
            });

            const displayFolders = computed(() => {
                if (currentFolder.value) return []; // 文件夹内不显示子文件夹（简化逻辑）
                return folders.value;
            });

            // 背景更新
            const updateBackground = () => {
                if (bgImage.value) {
                    document.body.style.backgroundImage = `url('${bgImage.value}')`;
                } else {
                    document.body.style.backgroundImage = 'none';
                    document.body.style.backgroundColor = bgColor.value;
                }
            };

            const saveSettings = () => {
                const config = { apiKey: apiKey.value, bgColor: bgColor.value, bgImage: bgImage.value };
                localStorage.setItem('rf_config', JSON.stringify(config));
                updateBackground();
                showSettings.value = false;
                alert('设置已保存');
            };

            // 智谱 API 调用
            const handleImageUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                if (!apiKey.value) {
                    alert('请先在设置中填写智谱 API Key');
                    return;
                }

                isLoading.value = true;

                // 转 Base64
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    const base64Image = reader.result.split(',')[1];
                    try {
                        await analyzeImage(base64Image);
                    } catch (e) {
                        alert('识别失败: ' + e.message);
                    } finally {
                        isLoading.value = false;
                        event.target.value = ''; // 重置 input
                    }
                };
            };

            const analyzeImage = async (base64) => {
                const prompt = `
                请分析这张图片，它通常是一个小说阅读APP的截图或封面。
                请提取以下信息：小说名称(title)、作者(author)、所属平台/网站(platform)。
                如果没有明确平台，根据界面风格猜测（如起点、晋江、番茄等），如果无法识别则留空。
                请只返回纯 JSON 格式数据，不要包含 Markdown 代码块标记（如 \`\`\`json）。
                格式示例: {"title": "书名", "author": "作者", "platform": "起点"}
                `;

                // 智谱 GLM-4V API 调用
                const response = await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey.value}`
                    },
                    body: JSON.stringify({
                        model: "glm-4v",
                        messages: [
                            {
                                role: "user",
                                content: [
                                    { type: "text", text: prompt },
                                    { type: "image_url", image_url: { url: base64 } }
                                ]
                            }
                        ]
                    })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                let content = data.choices[0].message.content;
                // 清理可能的 markdown 标记
                content = content.replace(/```json/g, '').replace(/```/g, '').trim();
                
                try {
                    const info = JSON.parse(content);
                    const newNovel = {
                        id: Date.now(),
                        title: info.title || '未知书名',
                        author: info.author || '未知作者',
                        platform: info.platform || '',
                        folderId: currentFolder.value ? currentFolder.value.id : null
                    };
                    novels.value.unshift(newNovel);
                } catch (e) {
                    throw new Error('无法解析 AI 返回的数据');
                }
            };

            // 手势处理
            const handleTouchStart = (e) => {
                touchStartX = e.changedTouches[0].screenX;
            };

            const handleTouchEnd = (e) => {
                const touchEndX = e.changedTouches[0].screenX;
                // 向左滑（进入设置）
                if (touchStartX - touchEndX > 100) {
                    showSettings.value = true;
                }
                // 向右滑（关闭设置或返回）
                if (touchEndX - touchStartX > 100) {
                    if (showSettings.value) showSettings.value = false;
                }
            };

            const startLongPress = (item, type) => {
                longPressTimer = setTimeout(() => {
                    selectedItem.value = item;
                    selectedType.value = type;
                    showActionSheet.value = true;
                    // 震动反馈
                    if (navigator.vibrate) navigator.vibrate(50);
                }, 600);
            };

            const cancelLongPress = () => {
                clearTimeout(longPressTimer);
            };

            // 文件夹逻辑
            const enterFolder = (folder) => {
                currentFolder.value = folder;
            };
            const exitFolder = () => {
                currentFolder.value = null;
            };

            // 操作菜单逻辑
            const closeActionSheet = () => {
                showActionSheet.value = false;
                selectedItem.value = null;
            };

            const deleteAction = () => {
                if (!confirm('确定要删除吗？')) return;
                
                if (selectedType.value === 'novel') {
                    novels.value = novels.value.filter(n => n.id !== selectedItem.value.id);
                } else {
                    // 删除文件夹及其内容
                    folders.value = folders.value.filter(f => f.id !== selectedItem.value.id);
                    // 将该文件夹内的小说移出到根目录，或者一并删除？这里选择移到根目录
                    novels.value.forEach(n => {
                        if (n.folderId === selectedItem.value.id) n.folderId = null;
                    });
                }
                closeActionSheet();
            };

            const renameAction = () => {
                const newName = prompt('重命名', selectedItem.value.name || selectedItem.value.title);
                if (newName) {
                    if (selectedType.value === 'folder') selectedItem.value.name = newName;
                    else selectedItem.value.title = newName;
                }
                closeActionSheet();
            };

            const createFolderWithItem = () => {
                const folderName = prompt('请输入新文件夹名称');
                if (folderName) {
                    const newFolder = { id: Date.now(), name: folderName };
                    folders.value.push(newFolder);
                    // 将当前选中的小说移入
                    const novel = novels.value.find(n => n.id === selectedItem.value.id);
                    if (novel) novel.folderId = newFolder.id;
                }
                closeActionSheet();
            };

            const moveToFolderAction = () => {
                if (folders.value.length === 0) {
                    alert('没有可用的文件夹');
                    return;
                }
                // 简单实现：弹窗输入文件夹名字（匹配）或 这里简化为将第一个文件夹作为演示
                // 理想情况应弹出一个列表供选择，这里为了代码简洁，仅演示：
                const folderNames = folders.value.map((f, index) => `${index + 1}. ${f.name}`).join('\n');
                const choice = prompt(`输入文件夹序号移入:\n${folderNames}`);
                const index = parseInt(choice) - 1;
                if (folders.value[index]) {
                     const novel = novels.value.find(n => n.id === selectedItem.value.id);
                     if (novel) novel.folderId = folders.value[index].id;
                }
                closeActionSheet();
            };
            
            const clearData = () => {
                if(confirm('确定清空所有记录？不可恢复！')) {
                    localStorage.clear();
                    location.reload();
                }
            };
            
            const viewNovel = (novel) => {
                // 点击小说卡片，暂时只提示信息，后续可扩展为详情页
                // alert(`书名：${novel.title}\n作者：${novel.author}`);
            };

            return {
                novels, folders, apiKey, bgColor, bgImage,
                showSettings, isLoading, currentFolder,
                displayNovels, displayFolders,
                showActionSheet, selectedItem, selectedType,
                handleImageUpload, saveSettings, clearData,
                handleTouchStart, handleTouchEnd,
                startLongPress, cancelLongPress,
                enterFolder, exitFolder, viewNovel,
                closeActionSheet, deleteAction, renameAction, createFolderWithItem, moveToFolderAction
            };
        }
    }).mount('#app');
</script>
</body>
</html>
